---
// components/RichTextEditor.astro
const { existingContent } = Astro.props;
import Headings from "../components/Headings.astro";
---

<div class="w-full">
  {/* Toolbar buttons */}
  <div class="flex gap-2 mb-2 flex-wrap">
    <button
      type="button"
      onclick="applyHeadingStyle(1)"
      class="px-3 py-2 rounded-lg bg-morning-fog/20 dark:bg-deep-ocean/20 hover:bg-sky-blue/10 dark:hover:bg-royal-periwinkle/20"
    >
      H1
    </button>
    <button
      type="button"
      onclick="applyHeadingStyle(2)"
      class="px-3 py-2 rounded-lg bg-morning-fog/20 dark:bg-deep-ocean/20 hover:bg-sky-blue/10 dark:hover:bg-royal-periwinkle/20"
    >
      H2
    </button>
    <button
      type="button"
      onclick="applyHeadingStyle(3)"
      class="px-3 py-2 rounded-lg bg-morning-fog/20 dark:bg-deep-ocean/20 hover:bg-sky-blue/10 dark:hover:bg-royal-periwinkle/20"
    >
      H3
    </button>
  </div>

  {/* ContentEditable area */}
  <div
    id="editorContent"
    class="w-full px-4 py-2 border border-morning-fog dark:border-deep-ocean dark:text-morning-fog/70 rounded-lg min-h-[300px] prose dark:prose-invert"
    contenteditable="true"
  >
  </div>

  {/* Hidden input */}
  <input type="hidden" name="content" id="hiddenContent" />
</div>

<script is:inline>
  // Apply heading styles from the component
  function applyHeadingStyle(level) {
    const selection = document.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const content = range.extractContents();

    const heading = document.createElement(`h${level}`);
    heading.className = getHeadingClasses(level);
    heading.appendChild(content);

    range.insertNode(heading);
    updateHiddenContent();
  }

  // Match the classes from your Headings component
  function getHeadingClasses(level) {
    const baseClasses =
      "text-sky-blue dark:text-royal-periwinkle border-morning-fog dark:border-deep-ocean ";
    return (
      baseClasses +
      ({
        1: "text-4xl font-bold mb-6 border-b pb-4",
        2: "text-3xl font-semibold mb-4 mt-8",
        3: "text-2xl font-medium mb-3 mt-6",
      }[level] || "")
    );
  }

  function updateHiddenContent() {
    const editor = document.getElementById("editorContent");
    const content = editor.innerHTML;
    document.getElementById("hiddenContent").value = content;

    // Trigger word count update
    if (typeof window.updateWordCount === "function") {
      window.updateWordCount(content);
    }
  }

  // Listen for input changes
  document
    .getElementById("editorContent")
    .addEventListener("input", updateHiddenContent);

  // Initialize on load
  document.addEventListener("DOMContentLoaded", function () {
    updateHiddenContent();
  });
</script>

<script is:inline>
  // Handle text formatting
  function formatText(tagName, className) {
    const selection = document.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const content = range.extractContents();
    const wrapper = document.createElement(tagName);
    wrapper.className = className;
    wrapper.appendChild(content);

    range.insertNode(wrapper);
    updateHiddenContent();
  }

  // Update hidden input
  function updateHiddenContent() {
    const editor = document.getElementById("editorContent");
    document.getElementById("hiddenContent").value = editor.innerHTML;
  }

  // Listen for input changes
  document
    .getElementById("editorContent")
    .addEventListener("input", updateHiddenContent);
</script>

<style>
  #editorContent:focus {
    outline: 2px solid theme("colors.sky-blue");
    outline-offset: 2px;
  }

  .dark #editorContent:focus {
    outline-color: theme("colors.royal-periwinkle");
  }

  .prose h1 {
    @apply text-4xl font-bold mb-6 text-sky-blue dark:text-royal-periwinkle border-b border-morning-fog dark:border-deep-ocean pb-4;
  }

  .prose p {
    @apply mb-4 leading-relaxed;
  }
</style>
